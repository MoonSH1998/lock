<!DOCTYPE html>
<html lang="en">
<head>
    <meta name=viewport content="width=device-width, initial-scale=1, user-scalable=0, viewport-fit=cover">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<!--    <link rel="shortcut icon" href="images/main-logo.png">-->
    <link rel="stylesheet" href="css/core.css" media="only screen">
    <link rel="stylesheet" href="/css/bootstrap.min.css">
    <link href="https://cdn.jsdelivr.net/npm/remixicon@3.4.0/fonts/remixicon.css" rel="stylesheet">
    <title></title>
    <style>
        .login-title{padding-top:10%;font-weight:bold;font-size:40px;color:#0E58D6}
        form label{font-size:18px;color:white}
        form input{padding:5px;background-color:transparent;color: #D5DBFF;border:none;border-bottom:1px solid #D5DBFF}
        form input::placeholder{color: #D5DBFF}
        .button{padding:13px 13px}
        .permission0.show{display:block}
        .permission0{display:none}
        .permission1.show{display:block}
        .permission1{display:none}
        .cancel-locker{display:none}
        .cancel-locker.show{display:flex}
        .only-manager{display:none}
        .only-manager.show{display:flex}
        .locker-status>div:before{content:url("/img/locker_status.svg");margin-right:16px;vertical-align:middle}
        .menus .possible{display:none}
        .menus .possible.show{display:block}
        .menus .impossible{display:none}
        .menus .impossible.show{display:block}
        .locker-status{display:none}
        .locker-status.show{display:block}
    </style>
</head>
<body>
<div class="container p-0">
    <div class="permission0" style="padding:10% 25px 0">
        <div class="d-flex flex-column justify-content-center align-items-center" style="gap:25px;margin-top:20%">
            <img src="/img/main0.svg">
            <div class="user-info fs-20 fw-bold text-center"></div>
            <div class="fw-bold fs-24">가입 승인 <span style="color:blue">대기 중</span> 입니다.</div>
        </div>
        <div class="button w-100 bg-white text-center" style="border-radius:30px;margin-top:11px;border:1px solid #0E58D6;color:#0E58D6;margin-top:50px">가입 취소하기</div>
        <div class="button w-100 text-center mt-2" onclick="SSO.logout()" style="border-radius:30px;margin-top:37px;color:white;background-color:#0E58D6">로그아웃</div>
    </div>

    <div class="permission1" style="min-height:100vh;background-color:#0E58D6;padding:0 25px">
        <div class="d-flex justify-content-between" style="padding-top:20%">
            <div class="d-flex" style="gap:30px">
                <div class="fs-28" style="color:white">안녕하세요 :)<br><span class="user-name fw-bold">{user-name}</span>님</div>
                <div class="d-flex mb-2" style="color:white">
                    <div class="align-self-end fs-10" onclick="SSO.logout()" style="padding-right:5px;border-bottom:1px solid #FFFFFF">로그아웃</div>
                    <div class="align-self-end" style="line-height:19px;margin-left:2px">></div>
                </div>
            </div>
            <div role="button" class="fs-28" style="color:white;height:max-content" onclick="Page.go('/editPassword.html')"><i class="ri-settings-5-fill"></i></div>
        </div>
        <section class="locker-status" style="margin-top:40px">
            <div class="bg-white" style="padding:7px 17px;border-radius:8px">현재 관리자가 <span class="fw-bold" style="color:#FF7676">사물함 신청 받는 중</span> 입니다</div>
        </section>
        <section class="menus" style="margin-top:22px">
            <div class="d-flex bg-white" style="border-radius:8px;padding:14px 11px">
                <div class="col-6" role="button" onclick="movePage()">
                    <div class="w-100 text-center" style="border-right:0.8px solid #DEE0EB;height:80%">
                        <img class="possible mx-auto" src="/img/locker_req_possible.svg">
                        <img class="impossible mx-auto" src="/img/locker_req_impossible.svg">
                    </div>
                    <div class="text-center">사물함 신청하기</div>
                </div>
                <div class="col-6" onclick="modal()">
                    <div class="w-100 text-center" style="height:80%">
                        <img src="/img/my_locker.svg">
                    </div>
                    <div class="text-center">내 사물함 보기</div>
                </div>
            </div>
            <div class="d-flex flex-column gap-1 align-items-end" style="margin-top:14px">
                <div role="button" class="cancel-locker text-decoration-underline fs-12 fw-light" onclick="cancelLocker()" style="color:white">사물함 신청 취소&nbsp;&nbsp;</div>
                <div role="button" class="only-manager text-decoration-underline fs-12 fw-light" onclick="Page.go('/mainM.html')" style="color:white">관리자로 로그인 하기&nbsp;&nbsp;</div>
            </div>
<!--            <div class="d-flex flex-column" style="gap:27px">-->
<!--                <div role="button" onclick="Page.go('/mainM.html')" class="only-manager justify-content-center" style="padding:16px 0;background-color:white;border-radius:8px;gap:10px">-->
<!--                    <img src="/img/add_uni.svg">-->
<!--                    <div class="fs-18" style="color:#0E58D6">관리자 모드</div>-->
<!--                </div>-->
<!--                <div role="button" onclick="Page.go('/userLockerRequest.html')" class="d-flex justify-content-center" style="padding:16px 0;background-color:white;border-radius:8px;gap:10px">-->
<!--                    <img src="/img/add_uni.svg">-->
<!--                    <div class="fs-18" style="color:#0E58D6">사물함 신청</div>-->
<!--                </div>-->
<!--                <div role="button" onclick="cancelLocker()" class="cancel-locker justify-content-center" style="padding:16px 0;background-color:white;border-radius:8px;gap:10px">-->
<!--                    <img src="/img/add_uni.svg">-->
<!--                    <div class="fs-18" style="color:#0E58D6">사물함 신청 취소</div>-->
<!--                </div>-->
<!--            </div>-->
        </section>
        <section class="uni-info fs-18 position-absolute text-center" style="color:white;bottom:34px;left:50%;transform:translate(-50%)">
            <div class="uni-name"></div>
            <div class="dep-name"></div>
        </section>
    </div>
</div>
</body>
</html>
<script src="js/jquery-3.5.1.min.js"></script>
<script src="https://developers.kakao.com/sdk/js/kakao.js"></script>
<script src="js/core.js"></script>
<script type="text/javascript">
    $(document).ready(function() {
        Page.init(location.pathname, init, {nolog: true});
    });
</script>
<script src="js/velocity.min.js"></script>
<script src="js/bootstrap.min.js"></script>
<script src="js/bootstrap.bundle.min.js"></script>
<script type="text/javascript">
    var pagectx = {};
    let mid = '';
    let depCode = '';
    let lockerFormStatus = '';
    function init(params) {
        pagectx = params;
        Dialog.init();
        renderPage(pagectx.usrobj);
        checkForm();
    }

    function checkForm(){
        mid = pagectx.usrobj.mid;
        depCode = pagectx.usrobj.depCode;
        AJAX.call('jsp/getLockerForm.jsp',{depCode : depCode},(data)=>{
            data = data.trim();
            if(data == 'null'){
                return;
            }else{
                checkLockerUser();
            }
        });
    }

    function checkLockerUser(){
        mid = pagectx.usrobj.mid;
        depCode = pagectx.usrobj.depCode;
        AJAX.call('jsp/getLockerUser.jsp',{mid:mid, depCode:depCode},(data)=>{
            data = data.trim();
            if(data == 'NO'){
                $('.cancel-locker').removeClass('show');
            }else{
                pagectx.lockerInfo = JSON.parse(data);
                if(pagectx.lockerInfo.type == 'C'){
                    $('.cancel-locker').removeClass('show');
                    return;
                }
                $('.cancel-locker').addClass('show');
            }
        });
    }

    function renderPage(user){
        console.log(user);
        if(user.permission == 1){
            $('.user-name').text(user.name);
            $('.uni-info .uni-name').text(user.uniName);
            $('.uni-info .dep-name').text(user.depName);
            $('.permission1').addClass('show');
            $('.permission0').removeClass('show');

            if(user.type == 'A'){
                $('.permission1 .only-manager').addClass('show');
            }else{
                $('.permission1 .only-manager').removeClass('show');
            }
        }else{
            $('.permission0 .user-info').append(`<p>${user.uniName}</p><p>${user.depName}</p>`);
            $('.permission1').removeClass('show');
            $('.permission0').addClass('show');
        }

        AJAX.call('jsp/getLockerFormStatus.jsp',{depCode:pagectx.usrobj.depCode},function(status){
            lockerFormStatus = status.trim();
            console.log(lockerFormStatus);
            if(lockerFormStatus == 'null' || lockerFormStatus == 'A'){
                $('.menus .impossible').addClass('show');
                $('.menus .possible').removeClass('show');
                $('.locker-status').removeClass('show');
            }else{
                $('.menus .impossible').removeClass('show');
                $('.menus .possible').addClass('show');
                $('.locker-status').addClass('show');
            }
        });
    }

    function cancelLocker(){
        AJAX.call('jsp/userLockerCancel.jsp',{mid:mid, depCode:depCode},()=>{
           Dialog.alert('사물함 신청이 취소되었습니다.',Page.reload);
        });
    }

    function modal(){
            if(pagectx.lockerInfo == undefined){
                Dialog.alert('배정된 사물함이 없습니다');
            }else if(lockerFormStatus == 'N'){
                Dialog.alert('사물함 배정이 완료되지 않았습니다.');
            }else{
                let lockerForm = pagectx.lockerForm;
                let locker = pagectx.lockerInfo;
                let way = pagectx.lockerForm.way == 'key' ? '<span class="fs-16" style="color:#ff4e09">현재 비밀번호가 아닌<br>자물쇠를 사용중입니다.</span>' : `${locker.password}`;
                $("body .container").append(`<div class="my-locker-modal modal show" tabindex="-1" style="display:block;z-index:0;background-color:rgba(0,0,0,0.5)">
            <div class="modal-dialog modal-dialog-centered" style="margin:38px">
                <div class="modal-content" style="padding:25px;border-radius:27px">
                    <div class="back-icon" style="left:0" role="button" onclick="hideModal('my-locker-modal')"></div>
                    <div class="fs-22 fw-bold" style="margin-top:28px">현재 <span style="color:#0E58D6">${locker.num}번</span><br>사용 중입니다</div>
                    <div id="pw" class="d-flex fs-14 justify-content-between" style="margin-top:53px">
                        <span>
                            자물쇠 이용  <input type="radio" name="way" value="key" disabled>
                        </span>
                        <span style="margin-left:50px">
                        도어락 이용  <input type="radio" name="way" value="password" disabled>
                        </span>
                    </div>
                    <div class="d-flex flex-column text-center" style="margin-top:20px;border-radius:16px;background-color:#F4F5FC;padding:15px;gap:20px">
                        <div class="fs-14" style="color:#686B7C">현재 사용 중인 비밀번호</div>
                        <div class="fs-22 fw-bold">${way}</div>
                        <div class="fs-10" style="color:#686B7C">비밀번호 변경위한<br>자세한 설정은 해당 과에 조교님께 연락해보세요</div>
                    </div>
                    <div class="d-flex justify-content-between" style="margin-top:30px">
<!--                        데이터 없음-->
                        <div>현재 사물함 쉐어 인원 :</div>
                        <div class="list-num" style="color:#0E58D6">1명</div>
                    </div>
                    <div class="share-list"></div>
<!--                    데이터 입력 없음-->
<!--                    <div class="fs-10 fw-light" style="color:#707070">학과 관련 전화번호 눌러서 확인하기</div>-->
                    <button id="dialogOk" type="button" style="margin-top:90px;border-radius:8px;color:white;background-color:transparent;padding:12px;border:1px solid #0E58D6;color:#0E58D6" onclick="hideModal('my-locker-modal')" class="btn btn-sm btn-primary fs-18">확인</button>
                </div>
            </div>
        </div>`);

                if(lockerForm.way == 'password'){
                    $('#pw input[value=password]')[0].checked = true;
                    $('#pw input[value=key]')[0].checked = false;
                }else{
                    $('#pw input[value=password]')[0].checked = false;
                    $('#pw input[value=key]')[0].checked = true;
                }

                AJAX.call('jsp/getLockerShare.jsp',{depCode:pagectx.usrobj.depCode,num:locker.num},(datas)=>{
                    datas = JSON.parse(datas);
                    console.log(datas);
                    let length = datas.length -1 >= 0 ? datas.length -1 : 0;
                    $('.list-num').text(`${length}명`);
                    for(const data of datas){
                        if(data.mid == pagectx.usrobj.mid){
                            continue;
                        }else{
                            $('.share-list').append(`<div class="d-flex justify-content-between" style="margin-top:22px">
                        <div class="d-flex gap-1">
                            <img src="/img/user_profile.svg" style="max-width:34px">
                            <div class="d-flex flex-column justify-content-between" style="color:#686B7C">
                                <div class="fs-14">${data.depName}</div>
                                <div class="fs-10">${data.studentId} / ${data.phoneNum}</div>
                            </div>
                        </div>
                        <div class="fs-14 fw-bold">${data.name}</div>
                    </div>`);
                        }
                    }

                    if(length == 0){
                        $('.share-list').append(`<div class="text-center w-100" style="margin-top:22px;color:#b1b1b1">혼자 사용 중입니다.</div>`);
                    }
                });
            }
    }

    function modal2(status){
        let str = status == 'null' ? '현재 <span style="color:#FF7676">신청 가능한 <br>사물함이 없습니다.</span>' : '현재 사물함 <span style="color:#FF7676">신청 기간이<br>마감이 되었습니다.</span>';
            $("body .container").append(`<div class="locker-req-modal modal show" tabindex="-1" style="display:block;z-index:0;background-color:rgba(0,0,0,0.5)">
            <div class="modal-dialog modal-dialog-centered" style="margin:38px">
                <div class="modal-content" style="padding:25px;border-radius:27px">
                    <div class="back-icon" style="left:0" role="button" onclick="hideModal('locker-req-modal')"></div>
                    <div class="fs-22 fw-bold text-center" style="margin-top:56px">${str}</div>
                    <div class="text-center fs-12" style="color:#686B7C;margin-top:38px">자세한 관련 문의는 각 학과 조교님에게<br>관련 문의 주시면 감사합니다.</div>
                    <button id="dialogOk" type="button" style="margin-top:10px;border-radius:8px;color:white;background-color:transparent;padding:12px;border:1px solid #0E58D6;color:#0E58D6" onclick="hideModal('locker-req-modal')" class="btn btn-sm btn-primary fs-18">확인</button>
                </div>
            </div>
        </div>`);
    }

    function hideModal(modal){
        $(`.${modal}`).remove();
    }

    function movePage(){
        if(lockerFormStatus == 'null' || lockerFormStatus == 'A'){
            modal2(lockerFormStatus);
        }else{
            Page.go('/userLockerRequest.html');
        }
    }
</script>